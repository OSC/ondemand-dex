#!/usr/bin/make -f
# You must remove unused comment lines for the released package.
# See debhelper(7) (uncomment to enable)
# This is an autogenerated template for debian/rules.
#
# Output every command that modifies files on the build system.
export DH_VERBOSE = 1
#
export SESSION_COMMIT = 703e26bc109e86d00be22ef1803bdb96b2dc09e2
export GO_VERSION = 1.17.10
export BUILDDIR = $(CURDIR)/build
export DEX_VERSION = $(VERSION:v%=%)
export GOPATH = /tmp/go
export PATH = /usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/local/sbin:$(GOPATH)/bin
export DEXDIR = $(BUILDDIR)/dex-$(DEX_VERSION)
export DESTDIR = $(CURDIR)/debian/ondemand-dex
export CONFDIR = $(DESTDIR)/etc/ood/dex
export UNITDIR = $(DESTDIR)/lib/systemd/system
export CONF_UNITDIR = $(DESTDIR)/etc/systemd/system

# main packaging script based on dh7 syntax
%:
	dh $@

override_dh_auto_configure:
	mkdir -p $(BUILDDIR)
	wget -q -O $(BUILDDIR)/dex.tar.gz https://github.com/dexidp/dex/archive/v$(DEX_VERSION).tar.gz
	tar -C $(BUILDDIR) -xzf $(BUILDDIR)/dex.tar.gz
	wget -q -O $(BUILDDIR)/session.patch https://github.com/OSC/dex/commit/$(SESSION_COMMIT).patch
	wget -q -O /tmp/go.tar.gz https://dl.google.com/go/go$(GO_VERSION).linux-amd64.tar.gz
	tar -C /tmp -xzf /tmp/go.tar.gz

override_dh_auto_build:
	cd $(DEXDIR) ; make build
	mv $(DEXDIR)/bin/dex $(DEXDIR)/bin/dex-orig
	cd $(DEXDIR) ; patch -p1 < $(BUILDDIR)/session.patch
	cd $(DEXDIR) ; make build
	mv $(DEXDIR)/bin/dex $(DEXDIR)/bin/dex-session

override_dh_auto_install:
	install -p -m 755 -D $(DEXDIR)/bin/dex-orig $(DESTDIR)/usr/sbin/ondemand-dex
	install -p -m 755 -D $(DEXDIR)/bin/dex-session $(DESTDIR)/usr/sbin/ondemand-dex-session
	install -p -m 600 -D $(DEXDIR)/examples/config-dev.yaml $(CONFDIR)/config.yaml
	touch $(CONFDIR)/dex.db
	mkdir -p $(DESTDIR)/usr/share/ondemand-dex
	cp -R web $(DESTDIR)/usr/share/ondemand-dex/web
	install -p -m 0644 -D packaging/session.conf.example $(CONF_UNITDIR)/ondemand-dex.service.d/session.conf.example
	dh_installsystemd

override_dh_auto_clean:
	rm -rf $(BUILDDIR)

override_dh_strip:
	# Do nothing

override_dh_builddeb:
	dh_builddeb -- -Zgzip
